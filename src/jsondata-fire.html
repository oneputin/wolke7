<link rel="import" href="../bower_components/polymer/polymer.html">

<script src="https://www.gstatic.com/firebasejs/3.2.0/firebase.js"></script>
<script src="app-config.js"></script>

<script>
  // Initialize Firebase
  // var fbConfig = {
  //   'wolke7': {  
  //     apiKey:        "AIzaSyC32ZX3rKvRFJTGZ7vVxxQX-WJCDPC01Dk",
  //     authDomain:    "wolke7-fd941.firebaseapp.com",
  //     databaseURL:   "https://wolke7-fd941.firebaseio.com",
  //     storageBucket: "wolke7-fd941.appspot.com"
  //   },
  //   'wolke9' :{
  //   }
  // };
  
  // firebase.initializeApp(fbConfig['wolke7'];);

</script>

<dom-module id="jsondata-fire">

  <template>

    <style>
      :host {
        display: block;
      }
    </style>

    <!-- <h5>query-log: firebase [[url]]/[[path]]</h5> -->

  </template>

  <script>

    Polymer({
      is: 'jsondata-fire',
      properties: {

        app: {  
          type: String,
          value: '',
          observer: 'initFB'
        },

        pathmode: false, 
        
        path:{
          type: String,
          // value: '',  //'/catalog/low' 
          observer : 'updatePathQuery'
        },

        itemname: {    // query(order)Item
          type: String //,  value: '' 
        },
        
        itemvalue:{          // queryValue (of orderItem)
          type: String //,  value: '' 
        },

        // operator: null,  // queryOperator(relating queryItem and queryValue)

        count: 10,       // number of returned objects(records)

        data: {
          type: Object,
          notify: true
        }
      },

      observers: [
        'updateItemQuery(path, itemname, itemvalue)'
      ],

      initFB: function(name, oldname) {
        if(!name) return; 
        if (!fbApp) { 
          if(!fbConfig) return;
          var config = fbConfig[name]; 
          if (!config) { // console.log("requested fbaccess is not available!"); 
            return;
          }
          // var fba = firebase.initializeApp(config, name); 
          fbApp = firebase.initializeApp(config); // console.log("fba created:" + fbApp.name, fbApp.options);
        }  
      },

      updatePathQuery: function(path, oldpath) { 
        if (!this.pathmode) return;  
        console.log("updatePathQuery, path=", path); 

        var that = this; // ALTMODISCH 
        firebase.database().ref(path).once('value').then(function(snapshot) { 
          // console.log("snapped pathmode", snapshot.val());
          that.data = snapshot.val();
        })
      },

      updateItemQuery: function(path, item, value) { 
        console.log("updateItemQuery: ", "path="+path,"var="+ item,"val="+ value); 

        var ref  = firebase.database().ref(path).orderByChild(item);

        if (value && (value != 'none')) {
          var op = this.operator;
          if (!op) {
            ref = ref.equalTo(value);
          } else { console.log("operator '"+op+"' not implemented!"); 

          } // console.log("updateItemQuery prepared: ", ref); 
        } 

        // OPTIONAL 
        var count = this.count; 
        if (count > 0) { 
          ref = ref.limitToFirst(count)
          console.log("added count to ref",count, ref);
        } 

        // APPLY the query 
        var that = this; // ALTMODISCH instead of "bind()"
        ref.once('value')
        .then(function(snapshot) { // console.log("query snapshot", snapshot.val());
            that.data = snapshot.val();
        })
        .catch( function (errorObject) {
          console.log("The read failed: " + errorObject.code);  
        });

      },



    });
  </script>
</dom-module>