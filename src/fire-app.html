<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="fire-base.js">
<!-- <script src="https://www.gstatic.com/firebasejs/3.2.1/firebase.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/3.2.1/firebase-app.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/3.2.1/firebase-database.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/3.2.1/firebase-store.js"></script> -->

<script>

  var fbConfig = {
      "wolke7": {  
        "apiKey":        "AIzaSyC32ZX3rKvRFJTGZ7vVxxQX-WJCDPC01Dk",
        "authDomain":    "wolke7-fd941.firebaseapp.com",
        "databaseURL":   "https://wolke7-fd941.firebaseio.com",
        "storageBucket": "wolke7-fd941.appspot.com"
      },
      "wolke9" :{
      }
  };
</script>

<dom-module id="fire-app">

  <template>

    <style>
      :host {
        display: block;
      }
    </style>
    
    <!-- <h5>query-log: firebase [[url]]/[[path]]</h5> -->

  </template>

  <script>

    Polymer({
      is: 'fire-app',
      properties: {

        app: {  
          type: String,
          notify: true
        },

        fb: {
          type: Object,
          notify: true
        }, 

        fbColl: {
          type: Object,
          value:{}
        },

        authmode: {
          type:String,
          value:""
        },  // "anonym",

        email: {
          type:String,
          value:""
        },  
        password: {
          type:String,
          value:""
        },  

        user: {
           type: Object
        } 

      },

      observers: [
        // 'getAuth(fb, authmode, email, password)'
      ],

      ready: function() { // console.log("firequery-ready");
        this.fbActivate(this.app);
      },

      fbActivate : function(name, nameold) { 
        if (!fbConfig) { console.log("BREAK. MISSING fb-configuration");
          this.fb = null;
          return;
        }  // console.log("fbActivate for ", name);
          
        var keys = Object.keys(fbConfig);
        if(!name) {
          name = keys[0];
          this.app = name; 
        }   

        var config = fbConfig[name]; //console.log("initFB:config",config);
        if (!config) {
          this.fb = null;
          return; 
        }

        // ??? 
        if (this.fbColl[name]) {  // console.log("Activate FB [" + name+"]");
          this.fb = this.fbColl[name];
        } else { console.log("Initialize new FB [" + name+"]", config);
          this.fb = firebase.initializeApp(config, name);  
          this.fbColl[name] = this.fb;
          this.getAuth(this.fb)
        } 
      },

      getAuth: function(fb, authmode, email, password) { 

        var auth = fb.auth(); 
        if (auth.currentuser) { console.log("curent user=", auth.currentuser);
          this.user = auth.currentuser;
          return; 
        } 

        if (!authmode) authmode=this.authmode;
        if (!email)    email=this.email;
        if (!password) password=this.password; 
        if (email && password)  authmode=="email";

        if (!authmode) authmode="anonym";   console.log("getAuth for authmode, email, password", authmode, email, password);
         

        if (authmode=="anonym") { 
          // Sign the user in anonymously since accessing Storage requires the user to be authorized.
          auth.signInAnonymously().then(function(user) {
            console.log('Anonymous Sign In Success', user);   
            this.user = user; // enable uploadbutton after signIn
          }).catch(function(error) {
            console.error('Anonymous Sign In Error', error);
            this.user = null;
          });
        }  

        if (authmode=="email") { 
          authmode = "email"; 
          auth.signInWithEmailAndPassword(email, password).then(function(user){
            console.log('Email SignIn Success', user); 
            this.user = user; // enable uploadbutton after signIn
          })
        }  

        // Default is popup for GoogleAccount  
        if (authmode=="popup") { // Default = "GoogleAuth"
          auth.signInWithPopup().then(function(user){
            console.log('Popup SignIn Success', user);   
            this.user = user; // enable uploadbutton after signIn
          })
        }  
      }

    });
  </script>
</dom-module>