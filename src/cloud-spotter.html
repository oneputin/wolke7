<script src="https://www.gstatic.com/firebasejs/3.2.0/firebase.js"></script>
<script>

  // Initialize Firebase
  var config = {
    apiKey:        "AIzaSyC32ZX3rKvRFJTGZ7vVxxQX-WJCDPC01Dk",
    authDomain:    "wolke7-fd941.firebaseapp.com",
    databaseURL:   "https://wolke7-fd941.firebaseio.com",
    storageBucket: "wolke7-fd941.appspot.com",
  };
  firebase.initializeApp(config);
</script>

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<!-- <link rel="import" href="../bower_components/paper-menu/paper-menu.html"> -->
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">

<!-- <link rel="import" href="jsondata-ajax.html">
<link rel="import" href="jsondata-fire.html">
 -->
<dom-module id="cloud-spotter">

  <!-- Defines the element's style and local DOM -->
  <template>
    <style>
      :host {
        display: block;
        padding: 10px;
      }
     
      .flex {
        @apply(--layout-horizontal);
      }   

      .flexvert {
        @apply(--layout-vertical);
      }   

      div.hidden {
        display: none;
      }
      
      label {
        font-weight: bold;
      }
      paper-fab {
        margin: 0px 20px;
      }
      paper-fab.label {
        font-size: 20px;
      }
      paper-fab.blue {
        --paper-fab-background: var(--paper-light-blue-500);
        --paper-fab-keyboard-focus-background: var(--paper-light-blue-900);
      }

      h1 {
        font-size: 22px;
        margin: 16px 0;
        color: #212121;
      }
      iron-data-table {
         @apply(--layout-horizontal);
      }      

    </style>
    
    <!-- Alternative query-methods -->

    <!-- <template is="dom-if" if="{{apiflag}}">
      <jsondata-fire url="[[url]]" path="[[path]]" data="{{imas}}"></jsondata-fire>
    </template>
    <template is="dom-if" if="{{!apiflag}}">
      <jsondata-ajax url="[[url]]"    path="[[path]]" data="{{imas}}"></jsondata-ajax>
    </template> -->

      <div class="container flex"> 
        <div>Load the cloud-image you want to analyse. 
        You may classify and comment it after it is activated.</div>
      </div>  
  
      <hr>

      <div class="container flex"> 
        
        <input id="file" type="file" name="file" on-change="handleFileSelect" disabled="[[disabled]]"/>
    
        <a href="[[serverurl]" target="_blank">
          <iron-image 
            style="width:200px; height:200px;" 
            sizing="contain"
            src="[[serverimg]]">          
          </iron-image>
        </a>  
      </div>  

      <!-- <form id="metaform" is="iron-form" method="get" action="processform"> -->
      <!-- <form id="metaform" is="iron-form" method="get" action="/"> -->
      <div id="metaform" class="flexvert hidden">

        <paper-input value="{{maintitle}}" label="title" required></paper-input>
        <paper-input value="{{subtitle}}" label="subtitleName"></paper-input>
        <!-- <paper-checkbox name="ref" checked="{{ref}}" required>Use in reference sets</paper-checkbox><br> -->
        <paper-dropdown-menu label="Calendar year">
          <paper-listbox class="dropdown-content" attr-for-selected="year" selected="{{year}}">
            <paper-item year="2002">2002</paper-item>
            <paper-item year="2003">2003</paper-item>
            <paper-item year="2004">2004</paper-item>
            <paper-item year="2005">2005</paper-item>
            <paper-item year="2006">2006</paper-item>
            <paper-item year="2007">2007</paper-item>
            <paper-item year="2008">2008</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
        
        <div>  
          <label id="label11">Howard</label>
          <paper-radio-group aria-labelledby="label11" required attrForSelected="name" selected="{{howard}}">
            <paper-radio-button name="heap">Heapy</paper-radio-button>
            <paper-radio-button name="sheet">Sheety</paper-radio-button>
            <paper-radio-button name="fleece">Fleecy</paper-radio-button>
          </paper-radio-group>
        </div>  
        
        <div>
          <label id="label21">Level</label>
          <paper-radio-group aria-labelledby="label21" attrForSelected="name" selected="{{level}}">
            <paper-radio-button name="low">low</paper-radio-button>
            <paper-radio-button name="middle">middle</paper-radio-button>
            <paper-radio-button name="high">high</paper-radio-button>
          </paper-radio-group>
        </div>
          
        <paper-dropdown-menu label="Main types (genus)" name="genus" required >
          <paper-listbox id="catmenu" class="dropdown-content" attr-for-selected="abbr" selected="{{genus}}">
            <paper-item abbr="ci">Cirrus</paper-item>
            <paper-item abbr="cc">Cirrocumulus</paper-item>
            <paper-item abbr="cs">Cirrostratus</paper-item>
            <paper-item abbr="ac">Altocumulus</paper-item>
            <paper-item abbr="as">Altostratus</paper-item>
            <paper-item abbr="ns">Nimbostratus</paper-item>
            <paper-item abbr="cu">Cumulus</paper-item>
            <paper-item abbr="cb">Cumulonimbus</paper-item>
            <paper-item abbr="sc">Stratocumulus</paper-item>
            <paper-item abbr="st">Stratus</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>

        <div>
          <paper-button raised on-click="formSubmit">Submit</paper-button>
          <paper-button raised on-click="formReset">Reset</paper-button>
        </div>
        <div class="output"></div>
      </div>

  </template>

  <!-- Creates the element's prototype and registers it -->
  <script>

    var auth       = firebase.auth();  
    var storageRef = firebase.storage().ref();
    var dataRef    = firebase.database().ref();  // console.log("auth,store,db:", auth, storageRef, dataRef);
   
    Polymer({

      is: 'cloud-spotter',
      
      properties: {

        uploadpath : "clouds", // /symbols", 

        disabled : true,   // disable before signin=ok

        serverurl: "",
        serverimg : "",

        apiflag : -1,      // src-modes : 'file', 'rest', 'api'(to fb-db) 

        tabindex : -1,  // = index of query-path-options

        route: Object,
        
        url:  {
          type: String,
          value: "abcde"
        },
        path:  {
          type: String,
          value: ""
        },

        maintitle: "",
        subtitle: "",
        year: "",
        ref: false,
        howard: "",
        level: "",
        genus: "",

        meta: {
          type: Object,
          value : {}
        }  
      },

      // event-action of file-button 
      handleFileSelect: function(evt) { console.log("this", this); 
        var that = this;
        var gui_uploadbtn  = that.$.file,
            gui_linkbox    = that.$.linkbox;
            // gui_imgbox     = that.$.imgbox;

        evt.stopPropagation();
        evt.preventDefault();

        var file = evt.target.files[0]; console.log("file=", file);
        var filetype = file.type;

        if (filetype.indexOf("image") > -1) {
          // uploadpath = "images"
        }
        var metadata = {
          'contentType': filetype
          // 'customMetadata':{
          //   'srcApp': 'fb-quickstart',
          //   'author': 'wolf'
          // }
        };

        // Push to child path.
        // var uploadTask = storageRef.child(uploadpath +'/'+ file.name).put(file, metadata);
        var uploadRef  = firebase.storage().ref(this.uploadpath);
        var uploadTask = uploadRef.child(file.name).put(file, metadata);

        // Listen for errors and completion of the upload.
        // [START oncomplete]
        uploadTask.on('state_changed', null, function(error) {
          // [START onfailure]
          that.serverimg = "" ;
          console.error('Upload failed:', error);
          // [END onfailure]
        }, function() {
          
          var metaData = uploadTask.snapshot.metadata;

          // console.log("Metadata:",   metaData);
          // console.log('UploadSize',  uploadTask.snapshot.totalBytes,'bytes.');

          that.serverurl = metaData.downloadURLs[0];  console.log('File downloadUrl:', that.serverurl);
          
          // gui_linkbox.innerHTML = '<a href="'+that.serverurl+'" target="_blank">Click For File</a>';
          if (filetype.indexOf("image") > -1) {
            that.serverimg = that.serverurl ;
          } else {
            that.serverimg = "../images/app-icon-144.png" ; // default placeholder
          }

          // save the doc-reference to database 
          // 1. Get new key at the target path
          if (!dataRef.child('clouds')) { // target must exist to enable key-generator
            firebase.database().ref('clouds').set([]);
          }  
          
          var dbKey  = dataRef.child('clouds').push().key;
          var dbData = {
            "url"  :    metaData.fullPath,
            "name" :    metaData.name,
            "type" :    metaData.contentType,
            "updated":  metaData.updated,
            "custom" :  metaData.customMetadata  
          } ;

          // 2. 
          firebase.database().ref('clouds/' + dbKey).set(dbData); 

        });
      },

      observers: [
        'updateMeta(url, maintitle)'
      ],

      updateMeta: function(url, maintitle) {
        var m = this.meta;
        m["url"]              = this.url;
        m["title-main-pict"]  = this.maintitle;
        m["type-character"]   = this.howard;
        m["type-height"]      = this.level;
        m["title-sub-pict"]   = this.subtitle;
        m["type-genus"]       = this.genus;
        // m.ref = ref;
        console.log("actual meta:", m) ; // howard, level, maintitle, ref);
        return m;
      },

      formSubmit : function(event) { console.log("submit");
        var m = updateMeta() ;
        // var form = Polymer.dom(event).localTarget.parentElement;
        // var form = this.$.metaform;
        var content = JSON.stringify(event.detail); console.log("content:", content, event, form) 
        // form.submit();
      },
      
      formReset : function(event) { console.log("reset");
        // var form = Polymer.dom(event).localTarget.parentElement;
        // form.reset();
      },

      ready: function() {

        this.tabindex = 0;
        this.apiflag  = 0;

        // Sign the user in anonymously since accessing Storage requires the user to be authorized.
        auth.signInAnonymously().then(function(user) {
          console.log('Anonymous Sign In Success', user);   
          this.disabled = false; // enable uploadbutton after signIn
        }).catch(function(error) {
          console.error('Anonymous Sign In Error', error);
        });

        // this.$.metaform.addEventListener('iron-form-submit', function(event) {
        //   var content = JSON.stringify(event.detail)
        //   // this.querySelector('.output').innerHTML = JSON.stringify(event.detail);
        //   console.log("content:", content, event); 
        // });
      }

    });
  </script>

</dom-module>