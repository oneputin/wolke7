<script src="https://www.gstatic.com/firebasejs/3.2.0/firebase.js"></script>
<script>

  // Initialize Firebase
  var config = {
    apiKey:        "AIzaSyC32ZX3rKvRFJTGZ7vVxxQX-WJCDPC01Dk",
    authDomain:    "wolke7-fd941.firebaseapp.com",
    databaseURL:   "https://wolke7-fd941.firebaseio.com",
    storageBucket: "wolke7-fd941.appspot.com",
  };
  firebase.initializeApp(config);
</script>

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">

<!-- <link rel="import" href="jsondata-ajax.html">
<link rel="import" href="jsondata-fire.html">
 -->
<dom-module id="cloud-spotter">

  <!-- Defines the element's style and local DOM -->
  <template>
    <style>
      :host {
        display: block;
        padding: 10px;
      }
      .circle {
        display: inline-block;
        height: 64px;
        width: 64px;
        border-radius: 50%;
        background: #ddd;
        line-height: 64px;
        font-size: 30px;
        color: #555;
        text-align: center;
      }
     
      .flex {
        @apply(--layout-horizontal);
      }   
  
      paper-fab {
        margin: 0px 20px;
      }
      paper-fab.label {
        font-size: 20px;
      }
      paper-fab.blue {
        --paper-fab-background: var(--paper-light-blue-500);
        --paper-fab-keyboard-focus-background: var(--paper-light-blue-900);
      }

      h1 {
        font-size: 22px;
        margin: 16px 0;
        color: #212121;
      }
      iron-data-table {
         @apply(--layout-horizontal);
      }      

    </style>
    
    <!-- Alternative query-methods -->

    <!-- <template is="dom-if" if="{{apiflag}}">
      <jsondata-fire url="[[url]]" path="[[path]]" data="{{imas}}"></jsondata-fire>
    </template>
    <template is="dom-if" if="{{!apiflag}}">
      <jsondata-ajax url="[[url]]"    path="[[path]]" data="{{imas}}"></jsondata-ajax>
    </template> -->

      <div class="container flex"> 
        <div>Load the cloud-image you want to analyse. 
        You may classify and comment it after it is activated.</div>
      </div>  
  
      <hr>

      <div class="container flex"> 
        
        <input id="file" type="file" name="file" on-change="handleFileSelect" disabled="[[disabled]]"/>
    
        <a href="[[serverurl]" target="_blank">
          <iron-image 
            style="width:200px; height:200px;" 
            sizing="contain"
            src="[[serverimg]]">          
          </iron-image>
        </a>  
      </div>  
  </template>

  <!-- Creates the element's prototype and registers it -->
  <script>

    var auth       = firebase.auth();  
    var storageRef = firebase.storage().ref();
    var dataRef    = firebase.database().ref();  // console.log("auth,store,db:", auth, storageRef, dataRef);
   
    Polymer({

      is: 'cloud-spotter',
      
      properties: {

        uploadpath : "clouds", // /symbols", 

        disabled : true,   // disable before signin=ok

        serverurl: "",
        serverimg : "",

        apiflag : -1,      // src-modes : 'file', 'rest', 'api'(to fb-db) 

        tabindex : -1,  // = index of query-path-options

        route: Object,
        
        url:  {
          type: String,
          value: ""
        },


        path:  {
          type: String,
          value: ""
        },

        levels: {
          type: Object,
          value: [
            {"alias":"Low",
             "text": " 0 - 2000",
             "symbol":"C<sub>L</sub>"
            },
            {"alias":"Middle",
             "text": "2000 - 6000",
             "symbol":"C<sub>M</sub>"
            },
            {"alias":"High",
             "text": "+ 6000",
             "symbol":"C<sub>H</sub>"
           }
          ]
        }

      },

            // event-action of file-button 
      handleFileSelect: function(evt) { console.log("this", this); 
        var that = this;
        var gui_uploadbtn  = that.$.file,
            gui_linkbox    = that.$.linkbox;
            // gui_imgbox     = that.$.imgbox;

        evt.stopPropagation();
        evt.preventDefault();

        var file = evt.target.files[0]; console.log("file=", file);
        var filetype = file.type;

        if (filetype.indexOf("image") > -1) {
          // uploadpath = "images"
        }
        var metadata = {
          'contentType': filetype,
          'customMetadata':{
            'srcApp': 'fb-quickstart',
            'author': 'wolf'
          }
        };

        // Push to child path.
        // var uploadTask = storageRef.child(uploadpath +'/'+ file.name).put(file, metadata);
        var uploadRef  = firebase.storage().ref(this.uploadpath);
        var uploadTask = uploadRef.child(file.name).put(file, metadata);

        // Listen for errors and completion of the upload.
        // [START oncomplete]
        uploadTask.on('state_changed', null, function(error) {
          // [START onfailure]
          that.serverimg = "" ;
          console.error('Upload failed:', error);
          // [END onfailure]
        }, function() {
          
          var metaData = uploadTask.snapshot.metadata;

          console.log("Metadata:",   metaData);
          console.log('UploadSize',  uploadTask.snapshot.totalBytes,'bytes.');


          that.serverurl = metaData.downloadURLs[0];  console.log('File downloadUrl:', that.serverurl);
          
          // gui_linkbox.innerHTML = '<a href="'+that.serverurl+'" target="_blank">Click For File</a>';
          if (filetype.indexOf("image") > -1) {
            that.serverimg = that.serverurl ;
          } else {
            that.serverimg = "../images/app-icon-144.png" ;
          }

          // save the doc-reference to database 
          // 1. Get new key at the target path
          if (!dataRef.child('clouds')) { // target must exist to enable key-generator
            firebase.database().ref('clouds').set([]);
          }  
          
          var dbKey  = dataRef.child('clouds').push().key;
          var dbData = {
            "url"  : metaData.fullPath,
            "name" : metaData.name,
            "type" : metaData.contentType,
            "updated": metaData.updated,
            "custom" : metaData.customMetadata  
          } ;

          // 2. 
          firebase.database().ref('clouds/' + dbKey).set(dbData); 

        });
      },

      ready: function() {

        this.tabindex = 0;
        this.apiflag  = 0;

        // Sign the user in anonymously since accessing Storage requires the user to be authorized.
        auth.signInAnonymously().then(function(user) {
          console.log('Anonymous Sign In Success', user);   
          this.disabled = false; // enable uploadbutton after signIn
        }).catch(function(error) {
          console.error('Anonymous Sign In Error', error);
        });
      }

    });
  </script>

</dom-module>