<script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<!-- <link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html"> -->
<link rel="import" href="../bower_components/iron-form/iron-form.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<!-- <link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html"> -->
<!-- <link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html"> -->
<!-- <link rel="import" href="../bower_components/paper-menu/paper-menu.html"> -->
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">

<link rel="import" href="../bower_components/paper-styles/color.html">
<!-- <link rel="import" href="../bower_components/iron-icons/iron-icons.html"> -->
<link rel="import" href="my-icons.html">

<link rel="import" href="fire-store.html">
<link rel="import" href="cloud-form.html">
<link rel="import" href="fire-query.html">

<dom-module id="cloud-spotter">

  <!-- Defines the element's style and local DOM -->
  <template>
    <style>
      :host {
        display: block;
        padding: 10px;
      }
     
      .viewsize {
        width:500px; 
        height:500px;
      }
      .ctrlsize {
        width:400px; 
        height:400px;
      }
      .flex-horizontal {
        @apply(--layout-horizontal);
      }   

      .flex-vertical {
        @apply(--layout-vertical);
      }   
      .flex {
        @apply(--layout-flex);
      }
      div.hidden {
        display: none;
      }
      
      label {
        font-weight: bold;
      }
      paper-fab {
        margin: 0px 20px;
      }
      paper-fab.label {
        font-size: 20px;
      }
      paper-fab.blue {
        --paper-fab-background: var(--paper-light-blue-500);
        --paper-fab-keyboard-focus-background: var(--paper-light-blue-900);
      }

      h1 {
        font-size: 22px;
        margin: 16px 0;
        color: #212121;
      }
      iron-data-table {
         @apply(--layout-horizontal);
      }      

    </style>
    
      <div class="container flex-horizontal"> 
        <div>Load the cloud-image you want to analyse.</div> 
        <div>You may classify and comment it after it is activated.</div>
      </div>  
      <hr>
      <div class="container flex-horizontal"> 
        <input id="file" type="file" name="file" on-change="handleFileSelect" disabled="[[disabled]]"/>
        <iron-image 
          class="ctrlsize"
          sizing="contain"
          src="[[imgurl]]"          
          on-tap="downloadImg">
        </iron-image>
      </div>  
      
      <fire-store path="[[path]]" srcfile="[[file]]" response="{{storagemeta}}"></fire-store>

      <cloud-form path="[[path]]" file="[[file]]" indata="[[storagedata]]" outdata="{{clouddata}}"></cloud-form>

      <fire-query path="[[path]]" setdata="[[clouddata]]" ></fire-query> <!-- key="[[cloudkey]]" -->

  </template>

  <!-- Creates the element's prototype and registers it -->
  <script>

      Polymer({

      is: 'cloud-spotter',
      
      properties: {

        path: {
          type: String,
        },
          
        disabled : false,   

        queryurl: {     // triggers query 
          type: String,
          notify: true
        },

        path:  {
          type: String
        },
        
        storagemeta: {
          type: Object,
          value : {},
          observer: "storageResponse"
        },

        formindata: {
          type: Object,
          value : {},
          notify: true  
        },

        clouddata: {
          type: Object,
          value : {},
          notify: true  
        },

        storageurl : {   // updates the ctrl-image if changing  
          type: String, 
          notify: true
        }, 

        imgurl : {   // updates the ctrl-image if changing  
          type: String, 
          notify: true
        }

      },

      // event-action of file-button 
      handleFileSelect: function(evt) { // console.log("file selected: ", this); 
        evt.stopPropagation();
        evt.preventDefault();

        var file  = evt.target.files[0]; // console.log("file=", file);
        this.file = file; // file becomes a property of spotter
      },  
 
      storageResponse : function(meta, oldmeta) { 
        var filetype = meta.contentType,
            urls     = meta.downloadURLs; 
        if (!urls || !urls.length) return;  // console.log("storageResponse", meta);

        this.storageurl = urls[0]; 
        if (filetype.indexOf("image") > -1) { 
          this.imgurl = urls[0] ;  // console.log("apply downloadurl:", filetype, urls[0]); // return;
        } else {
          this.imgurl = "../images/app-icon-144.png" ; // default placeholder
        } 

        // prepare the formular-input extract some cloud-data from storagemeta
        if (this.storageurl) {
          var clmeta = {"url": this.storageurl};
          clmeta["title-main-pict"] = meta.name+"/"+meta.updated+"/"+meta.size;
          clmeta["disable"] = ["url"]; 
          // clmeta["type"] = meta.contentType;
          // clmeta["date"] = meta.updated;
          // clmeta["size"] = meta.size;

          this.storagedata = clmeta;   // ****  
        }  
      },

      downloadImg() {
        console.log("Want to download", this, this.storageurl +" ?"); 
      },

      ready: function() {

        this.uploadpath = this.path;
      }

    });
  </script>

</dom-module>