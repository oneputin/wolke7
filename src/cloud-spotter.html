<script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-styles/color.html">

<!-- <link rel="import" href="../bower_components/iron-icons/iron-icons.html"> -->
<link rel="import" href="my-icons.html">

<link rel="import" href="fire-app.html">
<link rel="import" href="fire-store.html">
<link rel="import" href="cloud-form.html">
<link rel="import" href="fire-query.html">
<link rel="import" href="fire-login.html">

<dom-module id="cloud-spotter">

  <!-- Defines the element's style and local DOM -->
  <template>

    <style>
      :host {
        display: block;
        padding: 10px;
      }
     
      .viewsize {
        width:500px; 
        height:500px;
      }
      .ctrlsize {
        width:64px; 
        height:64px;
      }
      .flex-horizontal {
        @apply(--layout-horizontal);
      }   
      .flex-horizontal > div{
        margin: 0 10px; 
      }   
      .flex-end-align {
          @apply(--layout-horizontal);
          @apply(--layout-end);
          height: 80px;
        }
      .flex-vertical {
        @apply(--layout-vertical);
      }   
      .flex {
        @apply(--layout-flex);
      }
      div.hidden {
        display: none;
      }
      
      label {
        font-weight: bold;
      }
      paper-fab {
        margin: 0px 20px;
      }
      paper-fab.label {
        font-size: 20px;
      }
      paper-fab.blue {
        --paper-fab-background: var(--paper-light-blue-500);
        --paper-fab-keyboard-focus-background: var(--paper-light-blue-900);
      }

      h1 {
        font-size: 22px;
        margin: 16px 0;
        color: #212121;
      }
      iron-data-table {
         @apply(--layout-horizontal);
      }      
      paper-spinner-lite.thick {
        --paper-spinner-stroke-width: 6px;
        margin-right: 10px;
      }
      .weak{
        color: grey;
      }
      .mm {
        margin:10px;
      }
      #top {
        background-color: white;
      }

      .main-fab {
          --paper-fab-background: var(--paper-light-blue-500);
          /*position: fixed;    /*relative to screen*/
          position: absolute; /*relative to parent element*/
          right: 50%;    
          top: 10%;
          /*bottom: 50%;*/
          z-index: 999;
      }   
      
    </style>

      <fire-login></fire-login>
          
      <!-- <div id="top" class="container flex-horizontal"> 
        <div>Option: Load a cloud-image you want to analyse and/or upload.</div> 
        <div>Classify and comment an image (new or selected from database) in the form below.</div>
      </div>  
      <hr>

      <div class="container flex-end-align"> 
        <paper-spinner-lite id="spinner" class="thick mm"></paper-spinner-lite>
        <paper-input type="file" id="file" name="file" label="upload image" on-change="handleFileSelect" class="flex mm"></paper-input>
        <div class="weak mm">[[status]]</div>
      </div> -->  

      <paper-fab icon="insert-photo" class="main-fab" level="3" on-tap="addopen"></paper-fab>

      <fire-store app="[[fbapp]]" path="[[path]]" srcfile="[[file]]" response="{{storagemeta}}"></fire-store>
      <!-- The raw query-response (storagemeta) is being translated 
           into the format of fbspot to refresh the form  -->

      <!-- 2. FORM  -->
      <cloud-form fbapp="[[fbapp]]" path="[[path]]" file="[[file]]" indata="[[fbspot]]" outdata="{{formdata}}" ></cloud-form>

      <!-- 3.  -->
      <fire-query app="[[fbapp]]" path="[[path]]" setdata="[[clouddata]]" key=[[fbkey]]></fire-query> <!-- key="[[cloudkey]]" -->

      <!-- 4. POPUP to add/upload images -->
      <paper-dialog id="adder">

        <h2>Image selection</h2>
        <!-- <div id="top" class="container flex-horizontal"> 
          <div>Option: Select a (cloud-)image from your device to analyse and/or upload.</div> 
          <div>Classify and comment the image in the related form.</div>
        </div>  
        <hr> -->
        
        <div class="container flex-end-align"> 
          <paper-spinner-lite id="spinner" class="thick mm"></paper-spinner-lite>
          <paper-input type="file" id="file" name="file" label="upload image" on-change="handleFileSelect" class="flex mm"></paper-input>
          <div class="weak mm">[[status]]</div>
        </div>          
      </paper-dialog>  

  </template>

  <!-- Creates the element's prototype and registers it -->
  <script>

    Polymer({

      is: 'cloud-spotter',
      
      properties: {

        fbapp: {
          type: String,
        },

        path: {
          type: String,
        },
        
        disabled : false,   

        queryurl: {     // triggers query 
          type: String,
          notify: true
        },

        path:  {
          type: String
        },
        
        storagemeta: {
          type: Object,
          value : {} //,
          // observer: "storageResponse"
        },

        fbspot: {
          type: Object
        },
        
        fbtrigger: 1,

        formdata: {
          type: Object,
          observer: 'checkFormSubmit'  
        },

        clouddata: {
          type: Object,
          value : {},
          notify: true  
        },

        storageurl : {   // updates the ctrl-image if changing  
          type: String, 
          notify: true
        }, 

        imgurl : {   // updates the ctrl-image if changing  
          type: String, 
          notify: true
        } ,

        file: {
          type: Object,
          notify: true  
        }
      },

      observers: [
        // '_spotChanged(fbspot.url)'
        // '_fileUploaded(file.name, )'
      ],

      ready: function() { console.log("spotter-page ready"); 
 
        this.uploadpath = this.path;
 
      },

      addopen : function(e) { //console.log("helpbutton clicked", e);
        var popup = this.$.adder;
        popup.open();
      },

      checkFormSubmit: function(data, dataold) { 
        // prepare submit of x.clouddata and x.fbkey
        var key, fbkey="" ;
        if (this.fbspot) key = this.fbspot.fbkey;
        if (key) fbkey = key;
        else     key = "new";  
        // console.log("checkFormSubmit for key="+key, data);

        if (confirm("Submit last edits with key "+key+"?")) {
          this.clouddata = data;
          this.fbkey  = fbkey;
          // this.fbspot = undefined;
        } 
      },

      // _spotChanged: function(url) { // console.log("spot-url (spotter):", url)
      // },

      // event-action of file-button 
      handleFileSelect: function(evt) { 
        evt.stopPropagation();
        evt.preventDefault();
        var el = evt.target,
            files = el.files;
        if (!files) { 
          el = Polymer.dom(el.root).querySelector('input');
          files = el.files; // console.log("Polymer-input", files); // return; 
        }
        if (files && files.length) {
          var file  = files[0]; // console.log("input-file-check:", file);
          this.file = file; // the file-object becomes a property of spotter
          this.status = this.fileStatus(file); console.log("finished fileselect: ", this.status); 
        }
        el = this.$.spinner;
        el.active = true;
      },  

      fileStatus: function(file) {
        var d = file.lastModifiedDate;
            status = d.getFullYear()+"/"+d.getMonth()+"/"+d.getDate();
        return status;
      },  

      storageResponse : function(meta, oldmeta) { 
       
        // A. Reset Ctrls related to img-upload 
        var el = this.$.spinner;
        el.active = false;

        var popup = this.$.adder;
        popup.close();

        var filetype = meta.contentType,
            urls     = meta.downloadURLs; 
        if (!urls || !urls.length) return;  // console.log("storageResponse", meta);

        this.storageurl = urls[0]; 
        if (filetype.indexOf("image") < 0) { 
          this.imgurl = "../images/app-icon-144.png" ; // default placeholder
        } else {
          this.imgurl = this.storageurl;  
        } // console.log("apply downloadurl:", filetype, this.storageurl); // return;

        // B. prepare the formular-input extracting some firedb-data from storagemeta
        if (this.storageurl) {
          var clmeta = {"url": this.storageurl};
          clmeta["title-main-pict"] = meta.name+"/"+meta.updated+"/"+meta.size;
          clmeta["disable"] = ["url"]; 
          // clmeta["type"] = meta.contentType;
          // clmeta["date"] = meta.updated;
          // clmeta["size"] = meta.size;

          this.fbspot = clmeta;   // ****  
        }  
      }

    });

  </script>

</dom-module>