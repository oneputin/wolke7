<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-styles/color.html">

<!-- <link rel="import" href="../bower_components/iron-icons/iron-icons.html"> -->
<link rel="import" href="my-icons.html">

<link rel="import" href="fire-app.html">
<link rel="import" href="fire-store.html">
<link rel="import" href="cloud-form.html">
<link rel="import" href="fire-query.html">
<link rel="import" href="fire-shield.html">

<dom-module id="cloud-spotter">

  <!-- Defines the element's style and local DOM -->
  <template>

    <style>
      :host {
        display: block;
        padding: 10px;
      }
     
      .viewsize {
        width:500px; 
        height:500px;
      }
      .ctrlsize {
        width:64px; 
        height:64px;
      }
      .flex-horizontal {
        @apply(--layout-horizontal);
      }   
      .flex-horizontal > div{
        margin: 0 10px; 
      }   
      .flex-end-align {
          @apply(--layout-horizontal);
          @apply(--layout-end);
          height: 80px;
        }
      .flex-vertical {
        @apply(--layout-vertical);
      }   
      .flex {
        @apply(--layout-flex);
      }
      div.hidden {
        display: none;
      }
      
      label {
        font-weight: bold;
      }
      paper-fab {
        margin: 0px 20px;
      }
      paper-fab.label {
        font-size: 20px;
      }
      paper-fab.blue {
        --paper-fab-background: var(--paper-light-blue-500);
        --paper-fab-keyboard-focus-background: var(--paper-light-blue-900);
      }

      h1 {
        font-size: 22px;
        margin: 16px 0;
        color: #212121;
      }
      iron-data-table {
         @apply(--layout-horizontal);
      }      
      paper-spinner-lite.thick {
        --paper-spinner-stroke-width: 6px;
        margin-right: 10px;
      }
      .weak{
        color: grey;
      }
      .mm {
        margin:10px;
      }
      #top {
        background-color: white;
      }

      .main-fab {
          --paper-fab-background: var(--paper-light-blue-500);
          /*position: fixed;    /*relative to screen*/
          position: absolute; /*relative to parent element*/
          right: 5%;    
          /*top: 10%;*/
          bottom: 5%;
          z-index: 999;
      }   
      
    </style>
      
      <!-- 1. Login-Shield -->
      <fire-shield user="{{user}}"></fire-shield>

      <!-- 2.1  FAB to open the download popup -->          
      <paper-fab icon="insert-photo" class="main-fab" level="3" on-tap="addopen"></paper-fab>
      <!-- 2.2 POPUP to select/upload images -->
      <paper-dialog id="adder">
        <h2>Image selection</h2>
        <div class="container flex-end-align"> 
          <paper-spinner-lite id="spinner" class="thick mm"></paper-spinner-lite>
          <paper-input type="file" id="file" name="file" label="upload image" on-change="handleFileSelect" class="flex mm"></paper-input>
          <div class="weak mm">[[filestatus]]</div>
        </div>          
      </paper-dialog>  
      
      <!-- 2.3  -->
      <fire-store app="[[fbapp]]" path="[[path]]" srcfile="[[file]]" response="{{storagemeta}}"></fire-store>
      <!-- The raw query-response (storagemeta) is being translated 
           into the format of fbspot to refresh the form  -->


      <!-- 3.1 FORM to edit metadata of image -->
      <cloud-form fbapp="[[fbapp]]" path="[[path]]" file="[[file]]" indata="[[fbspot]]" outdata="{{formdata}}" snap="{{snap}}"></cloud-form>

      <!-- 3.2 Upload/refresh metadata of the image -->
      <fire-query app="[[fbapp]]" path="[[path]]" setdata="[[clouddata]]" key=[[fbkey]]></fire-query> <!-- key="[[cloudkey]]" -->

  </template>

  <!-- Creates the element's prototype and registers it -->
  <script>

    Polymer({

      is: 'cloud-spotter',
      
      properties: {

        fbapp: {
          type: String,
        },

        path: {
          type: String,
          value: "cp"
        },
        
        disabled : false,   

        queryurl: {     // triggers query 
          type: String,
          notify: true
        },

        storagemeta: {
          type: Object,
          value : {},
          observer: "storageResponse"
        },

        fbspot: {
          type: Object
        },
        
        fbtrigger: {
          value:0
        },
         
        formdata: {
          type: Object,
          observer: 'checkFormSubmit'  
        },

        clouddata: {
          type: Object,
          value : {},
          notify: true  
        },

        storageurl : {   // updates the ctrl-image if changing  
          type: String, 
          notify: true
        }, 

        imgurl : {   // updates the ctrl-image if changing  
          type: String, 
          notify: true
        } ,

        file: {
          type: Object,
          notify: true  
        },
        user: {
          type: Object,
          value: {}          
        },

        // trigger 
        snap: {
          type: Object,
          observer: 'triggerPreview'
        },

        preview: {
          type: Object,
          notify: true
        },

        navtrigger:{
          type: String,
          notify: true
        }
      },

      observers: [
        // '_spotChanged(fbspot.url)'
        // '_fileUploaded(file.name, )'
      ],

      triggerPreview: function(n,o){
        var p = n;
        if (p.imgurl) {
          p.html   = "<a href='"+p.imgurl+"' target='_blank'>download</a>";
          p.header = "Fullview";
          p.footer = "Testphase";
        }  // console.log(p);
        this.preview = p; 
        this.navtrigger = "preview"; 
      },

      ready: function() { // console.log("spotter-page ready"); 

       },

      addopen : function(e) { //console.log("helpbutton clicked", e);
        var popup = this.$.adder;
        popup.open();
      },

      checkFormSubmit: function(formdata, dataold) { 
        // prepare submit to this.clouddata and this.fbkey
        var submitdata = {}, key, val, fbkey="", user=this.user ;

        if (this.fbspot) {
          submitdata = JSON.parse(JSON.stringify(this.fbspot));
          key = submitdata.fbkey;
        }

        if (key) fbkey = key;
        else     key   = "new";  
        
        // console.log("checkFormSubmit of data with key="+key, formdata, user);
        // 1. merge previous data (fbspot) with formdata
        for (var prop in formdata) { 
          val = formdata[prop];
          if (val=="_clear_") delete submitdata[prop]; //  
          else                submitdata[prop] = val; 
        }  

        if (user && !user.isAnonymous) {
          submitdata.uid = user.uid;
          if (fbkey)  submitdata.edited = user.email;          
          else        submitdata.created = user.email;          
        } // console.log("submitdata",submitdata, user);

        // 2. insert user-info if not anonymous
        var doit = 1; // confirm("Submit last form-edits with key "+key+"?"); 
        if (doit) {
          this.clouddata = submitdata;
          this.fbkey     = fbkey;
          this.fbspot    = undefined; // !!!
          window.history.back();
        } 
      },

      // _spotChanged: function(url) { // console.log("spot-url (spotter):", url)
      // },

      // event-action of file-button 
      handleFileSelect: function(evt) { 
        evt.stopPropagation();
        evt.preventDefault();
        var el = evt.target,
            files = el.files;
        if (!files) { 
          el = Polymer.dom(el.root).querySelector('input');
          files = el.files; // console.log("Polymer-input", files); // return; 
        }
        if (files && files.length) {
          var file  = files[0]; // console.log("input-file-check:", file);
          this.file = file; // the file-object becomes a property of spotter
          this.filestatus = this.fileStatusGet(file); console.log("handleFileSelect. fileStatus= ", this.filestatus); 
        }
        // show spinner until file is stored (!close in "storageResponse"!) 
        el = this.$.spinner;
        el.active = true;
      },  

      fileStatusGet: function(file) {
        var d = file.lastModifiedDate;
            status = d.getFullYear()+"/"+d.getMonth()+"/"+d.getDate();
        return status;
      },  

      storageResponse: function(meta, oldmeta) { 
       
        // A. Reset some Ctrls related to img-upload 
        var el = this.$.spinner;
        el.active = false;

        var popup = this.$.adder;
        popup.close();

        // 
        var filetype = meta.contentType,
            urls     = meta.downloadURLs; 
        if (!urls || !urls.length) return;  // console.log("storageResponse", meta);

        this.storageurl = urls[0]; 
        if (filetype.indexOf("image") < 0) { 
          this.imgurl = "../images/app-icon-144.png" ; // default placeholder
        } else {
          this.imgurl = this.storageurl;  
        } // console.log("apply downloadurl:", filetype, this.storageurl); // return;
        // B. prepare the formular-input extracting some firedb-data from storagemeta
        if (this.storageurl) {
          var clmeta = {"url": this.storageurl};
          clmeta["title-main-pict"] = meta.name+"/"+meta.updated+"/"+meta.size;
          clmeta["disable"] = ["url"]; 
          // clmeta["type"] = meta.contentType;
          // clmeta["date"] = meta.updated;
          // clmeta["size"] = meta.size;

          this.fbspot = clmeta;   // ****  
        }  
      }

    });

  </script>

</dom-module>