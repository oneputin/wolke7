<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">

<link rel="import" href="fire-query.html">
<link rel="import" href="fire-keys.html">
<link rel="import" href="fire-values.html">

<link rel="import" href="slide-show.html">

<!-- <link rel="import" href="../bower_components/iron-icons/iron-icons.html"> -->
<link rel="import" href="my-icons.html">
<!-- <link rel="import" href="cloud-alias.html"> -->

<dom-module id="cloud-viewer">

  <!-- Defines the element's style and local DOM -->
  <template>
  
    <style is="custom-style">
      :host {
        display: block;
        padding: 10px;
      }
      h1 {
        font-size: 22px;
        margin: 16px 0;
        color: #212121;
      }
  
      .flex-horizontal {
          @apply(--layout-horizontal);
      }
      .flex-child {
          @apply(--layout-flex);
      }   
      .main-fab {
          --paper-fab-background: var(--paper-light-blue-500);
          position: fixed;    /*relative to screen*/
          /*position: absolute; /*relative to parent element*/
          right: 16px;    
          top: 50%;
          /*bottom: 50%;*/
          z-index: 1000;
      }   
  
      paper-dialog {
        position: fixed;
        top: 100px;
        right: 50px;
        width: 400px;
        height: 400px;
        z-index: 1001;
        overflow: auto;
      }

    </style>

    <cloud-alias app="{{app}}" alias="{{cloudalias}}"></cloud-alias>  

    <div>Cloud-DB browser</div>

      <paper-dialog 
        id="spot-pop" 
        entry-animation="scale-up-animation"
        exit-animation="fade-out-animation"><!--  modal> -->
        <h2 id="spottitle">{{spottitle}}</h2>
        <p  id="spotobj"><pre>{{spotobj}}</pre></p>
      </paper-dialog>
      

    <div class="flex-horizontal">
      
      <!-- <cloud-alias alias="{{cloudalias}}"></cloud-alias>   -->
      <div>

        <fire-keys app="[[fbapp]]" path="[[path]]" filter="type" keys="{{queryitems}}"></fire-keys>
        
        <paper-dropdown-menu label="Classifications">
          <paper-listbox class="dropdown-content" attr-for-selected="value" selected="{{queryitem}}">
            <template is="dom-repeat" items="{{queryitems}}">
               <paper-item value="[[item]]">[[getAlias("type", item)]]</paper-item>
            </template>        
          </paper-listbox>
        </paper-dropdown-menu>
      
      </div>

      <div class="flex-child"></div>
      
      <div>
        
        <fire-values app="[[fbapp]]" path="[[path]]" item="[[queryitem]]" values="{{queryvalues}}"></fire-values> <!-- filter="type" --> 
        
        <paper-dropdown-menu label="Classes">
          <paper-listbox class="dropdown-content" attr-for-selected="value" selected="{{queryvalue}}">
            <template is="dom-repeat" items="{{queryvalues}}">
               <paper-item value="[[item]]">[[getAlias(queryitem, item)]]</paper-item>
            </template>        
          </paper-listbox>
        </paper-dropdown-menu>
      </div>
    </div>

    <paper-fab icon="create" class="main-fab" level="3" on-tap="spotViewTrigger"></paper-fab>
    <fire-query app="[[fbapp]]" path="[[spotpath]]" item="_path_" data="{{firedbspot}}"></fire-query>
    
    <hr/>
    <!-- query cloud-images -->

    <fire-query app="[[fbapp]]" path="[[path]]" item="[[queryitem]]" itemvalue="[[queryvalue]]" data="{{data}}"></fire-query>
    
    <slide-show imas="[[imas]]" selected="{{slideindex}}"></slide-show> <!-- [[imas]] are calculated from {{data}} -->

  </template>

  <!-- Creates the element's prototype and registers it -->
  <script>

    Polymer({

      is: 'cloud-viewer',
      
      properties: {
        
        fbapp:  {
          type: String
        },

        cloudalias: {  // object with several alias-name-objects (fi. genus-longnames) 
          type: Object
        }, 

        path:  {
          type: String
        },

        queryitems:{
          type: Array,
          observer: 'useQueryItems'
        },
        queryitem: {
          type: String
        },

        queryvalues:{
          type: Array,
          observer: 'useQueryValues'
        },
        queryvalue: {
          type: String
        },

        item: {
          type: String
        },
        itemvalue: {
          type: String
        },

        data: {
          type: Object,
          value: [] 
        },

        imas: {
          type: Object,
          computed: 'createSlides(data)'
        }, 

        slideindex : {
          type: Number,
          value: 0
        },

        spotpath: {
          type: String
        },

        firedbspot: { // used to exchange with other pages (fi. spotter)
          type: Object,
          // value: {},
          notify: true 
        }
      },

      observers : [
        'spotViewAction(firedbspot, spotpath)'
      ], 

      ready: function(){
        this.tabindex = 0;    // triggers view of FIRST Query-set
        this.item     = "type-character";
        // this.itemvalue = 'none';
        // this.item  = "type-year";
        // this.itemvalue = 2002;
      },

      getAlias: function(type, abbr) { // return abbr; console.log(type, abbr);
        // replace abbr with fulltext from cloud-alias-object
        if (!this.cloudalias) return abbr; 
        var alias = this.cloudalias[type]; 
        if (!alias) return abbr; 
        if (alias[abbr]) { // console.log("alias for type/abbr",type,abbr,alias[abbr]);  
          return alias[abbr];  
        }
        return abbr; 
      },

      spotViewTrigger: function() {  
        var i   = this.slideindex, 
            ima = this.imas[i];  
        if (!ima) return;
        this.spotpath = this.path+"/"+ima.fbkey;  // console.log("spot on element: "+i, "path="+this.spotpath); 
      }, 

      spotViewAction: function (spot, spotpath) {  // console.log(spotpath, spot);
        // A. remote transfer to spot-form 

        // B. local check in popup 
        this.spotobj   = JSON.stringify(spot, null, 2); 
        this.spottitle = spotpath; 

        var popup = Polymer.dom(this.root).querySelector('#spot-pop');
        popup.open();

        // this.page = 'spotter';    
      },

      useQueryItems: function(n,o) { //console.log("use query items:", n);
        this.queryitem = n[0];
      },

      useQueryValues: function(n,o) { // console.log("use query values:", n);
        this.queryvalue = n[0];
      },

      createSlides: function(data, olddata) { 
        if (!data) return; // console.log("data", data);
        if (!Array.isArray(data)) {
          data =  Object.keys(data).map(function(k){
            var obj = data[k];
            obj.key = k;
            return obj;
          });
        }  // console.log("Howard: dataArray", data); 

        // Prepare a standard-array (url, item) for "slide-show"
        var ima , title, index, nn = data.length, imas = [];
        data.forEach(function(item,index){  // console.log(index, item);
          index = "("+ (index+1) +"/" + nn +") ";
          title = item["title-main-pict"] ;
          if (item["title-sub-pict"]) title = title+" / "+item["title-sub-pict"] ;
          ima = {
            fbkey:  item.key,
            url:    item.url,
            title:  title,
            index:  index
          }
          imas.push(ima)
        }); // console.log("slideArray-length=", imas.length);
        return imas; 
      }

    });
  </script>

</dom-module>