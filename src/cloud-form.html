<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<!-- <link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html"> -->

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">

<link rel="import" href="fire-values.html">
<link rel="import" href="cloud-alias.html">
<link rel="import" href="tools.html">

<dom-module id="cloud-form">  

  <template>

    <style>
      :host {
        display: block;
        padding: 10px;
        background-color: white;
      }


      .flex-horizontal {
        @apply(--layout-horizontal);
      }   

      .flex-vertical {
        @apply(--layout-vertical);
      }   
      .flex {
        @apply(--layout-flex);
      }

      div.hidden {
        display: none;
      }
      
      .formlabel {
        /*font-weight: bold;*/
        font-size: 12px;
        color: grey;
      }
      paper-fab {
        margin: 0px 20px;
      }
      paper-fab.label {
        font-size: 20px;
      }
      paper-fab.blue {
        --paper-fab-background: var(--paper-light-blue-500);
        --paper-fab-keyboard-focus-background: var(--paper-light-blue-900);
      }

      h1 {
        font-size: 22px;
        margin: 16px 0;
        color: #212121;
      }
      iron-data-table {
         @apply(--layout-horizontal);
      }  
      
      .thumb {
        height: 64px;
        width: 64px;
      }
      #yearmenu {
        width: 120px;
      }
      .flex-equal-justified {
        @apply(--layout-horizontal);
        @apply(--layout-justified);
      }

      paper-menu.blue {
        --paper-menu-background-color: var(--google-grey-300);
      }
      .margin1 {
        margin: 10px 0px;
      }

    </style>
    
    <cloud-alias fbapp="[[fbapp]]" alias="{{cloudalias}}" trigger></cloud-alias>  

    <div id="metaform" class="container flex-vertical"> <!-- hidden -->

      <!-- 3 inputs -->
      <div class="container flex-horizontal"> 

        <paper-input value="{{url}}" label="url" id="url" class="formitem flex"></paper-input>

        <paper-button on-tap="thumbView">
          <iron-image 
            class ="thumb"
            sizing="cover"
            src   ="[[url]]">
          </iron-image>
        </paper-button>

      </div>  

      <paper-input value="{{title-main-pict}}" id="title-main-pict" label="title" class="formitem"></paper-input>

      <paper-input value="{{title-sub-pict}}" id="title-sub-pict" label="subtitle" class="formitem flex"></paper-input>
        <!-- <paper-toggle-button checked on-change="toggleFormSegments">clouds</paper-toggle-button> -->

      <div class="container margin1 flex-equal-justified"><!--  around-justified flex-horizontal"> -->  
        <div class="formlabel">data sections: </div>

        <paper-toggle-button id="clouditemsToggle" on-change="toggleFormSegments">clouds</paper-toggle-button>
        <paper-toggle-button id="imageitemsToggle" on-change="toggleFormSegments">image</paper-toggle-button>
      
      </div>

      <div id="clouditems" class="formsegment container flex-equal-justified hidden">  

        <div >
          <fire-values app="{{fbapp}}" path="[[path]]" item="type-height" values="{{heights}}"></fire-values> 
          <label class="formlabel" id="label21">Cloud bottom</label> <!-- <paper-checkbox id="height" checked>Height</paper-checkbox> -->
          <paper-menu class="formitem blue" id="type-height" aria-labelledby="label21" selected="{{type-height}}" attr-for-selected="value" allowEmptySelection>
              <template is="dom-repeat" items="{{heights}}">
                 <paper-item value="[[item]]">[[getAlias("type-height",item)]]</paper-item>
              </template>        
          </paper-menu>
        </div>

        <!-- <div class="flex"></div> -->
        
        <div>  
          <fire-values app="{{fbapp}}" path="[[path]]" item="type-character" values="{{classes}}"></fire-values>
          <label class="formlabel" id="label11">Cloud class</label> <!-- <paper-checkbox id="character" checked>Class</paper-checkbox> -->
          <paper-menu class="formitem blue" id="type-character" aria-labelledby="label11" selected="{{type-character}}" attr-for-selected="value" allowEmptySelection>
              <template is="dom-repeat" items="{{classes}}">
                 <paper-item value="[[item]]">[[item]]</paper-item>
              </template>        
          </paper-menu>
        </div>  

        <!-- <div>&nbsp;&nbsp;</div> -->

        <div >          
          <fire-values app="{{fbapp}}" path="[[path]]" item="type-genus" values="{{genuss}}"></fire-values> 
          <paper-dropdown-menu label="Main cloud type">
            <paper-listbox id="type-genus" class="formitem dropdown-content" attr-for-selected="value" selected="{{type-genus}}">
              <paper-item value="">  </paper-item>
              <template is="dom-repeat" items="{{genuss}}">
                 <paper-item value="[[item]]">{{getAlias("type-genus",item)}}</paper-item>
              </template>        
            </paper-listbox>
          </paper-dropdown-menu>
        </div>

      </div>

      <hr>

      <div  id="imageitems" class="formsegment container flex-horizontal hidden">    
        <div>
          <fire-values app="{{fbapp}}" path="[[path]]" item="type-year" values="{{years}}"></fire-values> <!-- filter="type" --> 
          <paper-dropdown-menu id="yearmenu" label="Calendar year">
            <paper-listbox id="type-year" class="formitem dropdown-content" attr-for-selected="value" selected="{{type-year}}">
              <paper-item value="">  </paper-item>
              <template is="dom-repeat" items="{{years}}">
                 <paper-item value="[[item]]">[[item]]</paper-item>
              </template>        
            </paper-listbox>
          </paper-dropdown-menu>
        </div>
      </div>

      <!--  2 Ctrl buttons -->
      <div class="container flex-horizontal">
        <!-- <paper-button id="submitbtn" raised on-click="submitterOpen">Submit</paper-button> -->
        <!-- <paper-button id="submitbtn" raised on-click="submitter.open()">Submit</paper-button> -->
        <paper-button id="submitbtn" raised on-click="formSubmit">Submit</paper-button>
        <paper-button raised on-tap="formResetClick" >Reset</paper-button>
        <div class="flex"></div>
      </div>


      <!-- OPTIONAL : does not become visible !! -->
      <paper-dialog id="submitter" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
        <h2>Confirmation</h2>
        <p>
          <paper-button  raised on-click="">check data</paper-button>
          <paper-button  raised on-click="formSubmit">Save data</paper-button>
        </p>
      </paper-dialog>

      <!-- Preview-Popup  -->
      <paper-dialog 
        id="formimg" 
        entry-animation="scale-up-animation"
        exit-animation="fade-out-animation"><!--  modal> -->
        <paper-dialog-scrollable>
          <div class="buttons">
            <paper-button dialog-confirm autofocus>Close</paper-button>
          </div>
          <h2></h2>
          <iron-image id="fullimage" src="[[fullsrc]]">
          </iron-image>
          <p></p>
        </paper-dialog-scrollable>
      </paper-dialog>
    
    </div>

  </template>

  <script>

    Polymer({

      is: 'cloud-form',
      
      properties: {

        fbapp: {
          type: String
        },

        cloudalias: {  // object with several alias-name-objects (fi. genus-longnames) 
          type: Object
        }, 

        spotindex: {
          type: String,
          observer: 'setupForm'
        },

        path:  {
          type: String,
          value: ""
        },

        indata: {
          type: Object,
          // value: function(){return {};}, 
          observer: "inCtrl"
        },  
        
        outdata: {
          type: Object,
          notify: true
        },

        snap: {
          type: Object,
          notify: true          
        }

      },

      observers: [
        // "debugRec(rec)" // , rec.url, rec.title-main-pict, rec.title-sub-pict, rec.type-genus)"
      ],

      getAlias: function(type, abbr) { // applied directly in generated HTML. console.log(type, abbr);
        if (!this.cloudalias) return abbr; 
        var alias = this.cloudalias[type]; 
        if (!alias) return abbr; 
        if (alias[abbr]) { // console.log("alias for type/abbr",type,abbr,alias[abbr]);  
          return alias[abbr];  
        }
        return abbr;
      },

      submitterOpen: function() { // OPTION: starts submit with confirmation 
        this.$.submitter.open();
      },

      // Toggle visibility of formsegments 
      // and reset its input-element-values to "null" if hidden  (???)
      toggleFormSegments: function(e, id) { 
        var makevisible = true, reset = true;
        if (e) {
          id = e.target.id.replace("Toggle", "");
          makevisible = e.target.checked;
          reset = false;
        } 

        var formsegment = Polymer.dom(this.root).querySelector("#"+id); 
        if (makevisible) {
            formsegment.classList.remove("hidden");
        }  else  { // console.log('unchecked');
            formsegment.classList.add("hidden");
            if (reset) this.formReset(id); // ??? 
        }
      },

      setupForm: function(key, oldkey) {
        console.log("setup spotForm for", key); 
      },

      inCtrl : function(indata,inold) { // console.log("inCtrl", indata);
          
          if (!indata || !Object.keys(indata).length) return; 
          // var ik = Object.keys(indata); if (!ik.length) return; // console.log("updating form with input data", indata);

          // 1. 
          
          this.formReset(); 

          // 2. Transfer content from indata-object into form-elements (props)
          //    Set flag on formsegments that got an indata value 
          var formitems = Polymer.dom(this.root).querySelectorAll(".formitem"),
              segments = Polymer.dom(this.root).querySelectorAll(".formsegment"),
              segmentFlags = {}, that=this, prop;

          formitems.forEach(function(elem, index){  
            prop = elem.id; // console.log("prop, indata.prop", prop, indata[prop]);
            
            // try to extract only indata-items that are defined in "formitems"  
            if (indata[prop]) {
              that[prop] = indata[prop]; //console.log(prop, this[prop]);

              // 
              segments.forEach(function(segment, index){  // console.log("segmentKey, prop", segment.id, prop);
                if (Polymer.dom(segment).querySelector("#"+prop)) segmentFlags[segment.id] = true;
              })
            } 
          }) 

          // 2.2 make segments visible that contain at least one refreshed element
          for (var key in segmentFlags) { 
            Polymer.dom(this.root).querySelector("#"+key+"Toggle").click(); 
            // this.toggleFormSegments(null, key);
          }
          // extract required form-data from indata (if existing there)  

          // 3. Manage disable-status of items marked in indata.disable-array
         
          if (indata.disable) {
            var that = this;
            indata.disable.forEach(function(item,index){
              Polymer.dom(that.root).querySelector("#"+item).setAttribute("disabled", true);
              // this.$.(item).setAttribute("disabled", true);
            })
          } 
          this.indata = {};
          this.$.metaform.classList.remove("hidden");

      },

      // outCtrl: function(outdata,outold) { console.log("outCtrl", outdata); 
          // Open/Close the form
          // if (outdata.flag === "set")  {
          //   this.$.metaform.classList.add("hidden");
          // } else {
          //   this.$.metaform.classList.remove("hidden");
          // } 
      // },

      debugRec : function(p1, p2, p3,p4) { console.log(p1,p2,p3,p4); 

      },

      enableSubmit: function(rec, oldrec){  
        if (rec.url && rec["title-main-pict"]) { console.log("enableSubmit", rec);
          // this.$.submitbtn.setAttribute("disabled", false);
        } else if (!title) { console.log("disableSubmit", title);
          // this.$.submitbtn.setAttribute("disabled", true);
        } 
      },

      formDataManager: function(name, set) {
        // 
        var obj, that=this;
        if (name) obj = this[name];
        else name = "anonym";
        if (!obj) obj = {};


        var formitems = Polymer.dom(this.root).querySelectorAll(".formitem"); // console.log("formSegments", typeof segments, segments);          

        formitems.forEach(function(elem, index){  // console.log("segmentKey, prop", segment.id, prop);
         
          prop = elem.id;
         
          if   (set && (obj[prop]!==null)) {   // form-props aus object übernehmen 
            
            that[prop] = obj[prop];  

          } else if (that[prop])  { 
            // object aus form-props aktualisieren
            
            obj[prop]  = that[prop];
          }  
        }) // console.log("formDataManager ["+name+"] finished: ", obj)   

        return obj;
      } ,

      formSubmit: function(event) {


        var data = this.formDataManager(); //console.log("submitting data to "+this.fbpath+"//"+this.fbkey, data);
        
        // console.log("optionally confirm data in custom element:",data);
        // if (confirm("Submit last edits!")) {
        this.outdata = data;  
        // }
        
        // Option: HIDE the form 
        // this.$.metaform.classList.add("hidden");
          
      },

      formResetClick: function(e) { // console.log("formresetClick", e); 
        this.formReset();
      },

      formReset : function(segmentid) {  // console.log("formreset"); // return; 

          var formDom  = Polymer.dom(this.root);
          var elems    = formDom.querySelectorAll(".formitem"); // console.log("formSegments", typeof segments, segments);
          var segments = formDom.querySelectorAll(".formsegment"); // console.log("formSegments", typeof segments, segments);

          // 1. hide all formsegments an reset ist parameter-objects 
          var that = this;

          segments.forEach(function(segment, index){  // console.log("segmentKey, prop", segment.id, prop);
           
            if (segmentid) {
              if (segmentid != segment.id) return;
              elems = Polymer.dom(segment).querySelectorAll(".formitem");
            }
            
            that[segment.id] = {}; // reset the segment-data-object

            var t = formDom.querySelector("#"+segment.id+"Toggle");
            // console.log("hide segment:"+segment.id, t);
            if (t && t.checked) t.click(); // sync of toggle and segment-hidden
            else                segment.classList.add("hidden"); // segment-hidden only
          })
          
          // 1. remove content and/or seletions
          var that=this, prop; 

          elems.forEach(function(elem, index){  // console.log("segmentKey, prop", segment.id, prop);

            prop = elem.id; 
           
            // A. resetting the content of ctrl-objects 
            if (that[prop]) that[prop] = ""; 

            if (segmentid && that[segmentid]) that[segmentid][prop] = ""; 

            if (that.outdata) that.outdata[prop] = ""; 
            
            // B. HARD-RESET of iron-selection on elements with item-lists (menus, button-group, ...) 
            // this to avoid backward binding to FORM-properties !!
            if (elem.items) { 
              elem.items.forEach(function(it,i){
                it.classList.remove("iron-selected"); // *** 
              });
            }  
          }) 
      },

      ready: function() {
        if (this.indata && this.indata.url) this.formitems.url = this.indata.url;
      },

      thumbView: function(e){
        // popupTop(e, this, "formimg");
        getImageSrc(e, this, "snap");
      }

    });
  </script>

</dom-module>