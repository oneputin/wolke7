<link rel="import" href="../bower_components/polymer/polymer.html">

<script src="https://www.gstatic.com/firebasejs/3.2.0/firebase.js"></script>
<script src="app-config.js"></script>

<script src="https://www.gstatic.com/firebasejs/3.2.0/firebase.js"></script>
<script>
  // Initialize Firebase
  // var config = {
  //   apiKey:        "AIzaSyC32ZX3rKvRFJTGZ7vVxxQX-WJCDPC01Dk",
  //   authDomain:    "wolke7-fd941.firebaseapp.com",
  //   databaseURL:   "https://wolke7-fd941.firebaseio.com",
  //   storageBucket: "wolke7-fd941.appspot.com",
  // };
  // firebase.initializeApp(config);
</script>

<dom-module id="fire-store">

  <template>

    <style>
      :host {
        display: block;
      }
    </style>

    <!-- <h5>query-log: firebase [[url]]/[[path]]</h5> -->

  </template>

  <script>

    // var auth       = firebase.auth(),  
    //     storageRef = firebase.storage().ref(),
    //     dataRef    = firebase.database().ref();  // console.log("auth,store,db:", auth, storageRef, dataRef);
    // var dbPath     = "cp"; // "clouds";

    Polymer({
      is: 'fire-store',
      properties: {

        app: {  
          type: String,
          observer: 'initFB'
        },

        path:{
          type: String //,bserver : 'applyPathQuery'
        },

        srcfile: {     // triggers upload
          type: Object, 
          observer: 'applyStorageUpload'
        },

        srcmeta: {     // triggers upload
          type: Object 
        },

        queryurl: {    // triggers download     
          type: String
        },

        response: {
          type: Object,
          notify: true
        }
      },

      observers: [
        'applyStorageQuery(path, queryurl)'// , localurl)'
      ],

      ready: function() { // console.log("firequery-ready");
        this.initFB(); 
    
        var auth = firebase.auth();
        // Sign the user in anonymously since accessing Storage requires the user to be authorized.
        auth.signInAnonymously().then(function(user) {
          console.log('Anonymous Sign In Success', user);   
          this.disabled = false; // enable uploadbutton after signIn
        }).catch(function(error) {
          console.error('Anonymous Sign In Error', error);
        });
      },

      initFB: function(name, oldname) { //console.log("initFB:start");
        if (!fbConfig) return;
        if (!fbApp) { 
          var keys = Object.keys(fbConfig);
          if(!name) name = keys[0]; 
          var config = fbConfig[name]; //console.log("initFB:config",config);
          if (!config) return; 
          // var fba = firebase.initializeApp(config, name); 
          fbApp = firebase.initializeApp(config); // console.log("fba created:" + fbApp.name, fbApp.options);
        }  
      },

      applyStorageUpload: function(file) {
        if (!file) return; 
        
        var metadata = { // storage-object meta !!
          'contentType': file.type
        }   
        if (this.srcmeta) {
          metadata["customMetadata"] = this.srcmeta;
        } console.log("uploadmeta of " + file.name, metadata);

        var uploadRef  = firebase.storage().ref(this.uploadpath);        
        var uploadTask = uploadRef.child(file.name).put(file, metadata);  // 

        // Listen for errors and completion of the upload.
        var that = this;  

        uploadTask.on('state_changed', 
          null, 
          function(error) {
            that.serverurl = "" ; // hide the last img !!
            console.error('Upload failed:', error);
          }, 
          function() {  
            var snap  = uploadTask.snapshot;  
            // var bytes = snap.totalBytes; 
            that.response = snap.metadata;   
            // that.storageurl = that.response.downloadURLs[0];  
            // console.log('responsemeta ', that.response ); 
        });
      },

      applyStorageQuery: function(path, queryurl) {  console.log("start query"); return; 
        
        if (this.item=="_path_") {  // console.log("applyPathQuery, path=", path); 
          if (!fbApp) this.initFB();

          var that = this; // ALTMODISCH (use bind() instead?)
          firebase.database().ref(path).once('value').then(function(snapshot) { 
            // console.log("snapped pathmode", snapshot.val());
            that.data = snapshot.val();
          })
        }
      },

      // applyItemQuery: function(path, item, value) { 
        
      //   // console.log("applyItemQuery: ", "path="+path,"var="+ item,"val="+ value); 

      //   if (!fbApp) this.initFB();
      //   var that = this; // ALTMODISCH (use bind() instead?)

      //   // if (this.item=="_path_") {  // console.log("applyPathQuery, path=", path); 
      //   //   firebase.database().ref(path).once('value').then(function(snapshot) { 
      //   //     that.data = snapshot.val();
      //   //   })
      //   //   return; 
      //   // }

      //   var ref  = firebase.database().ref(path).orderByChild(item);

      //   if (value && (value != '_all_') ) {
      //     var op = this.operator;
      //     if (!op) {
      //       ref = ref.equalTo(value);
      //     } else { console.log("use of operator '"+op+"' not implemented!"); 

      //     } // console.log("applyItemQuery prepared: ", ref); 
      //   } 

      //   // OPTIONAL 
      //   var count = this.count; 
      //   if (count > 0) { 
      //     ref = ref.limitToFirst(count)
      //     console.log("apply count to ref: ",count, ref);
      //   } 

      //   // APPLY the query 
      //   ref.once('value')
      //   .then(function(snapshot) { // console.log("query snapshot", snapshot.val());
      //       that.data = snapshot.val();
      //   })
      //   .catch( function (errorObject) {
      //     console.log("The read failed: " + errorObject.code);  
      //   });
      // }

    });
  </script>
</dom-module>