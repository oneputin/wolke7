<script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-styles/color.html">

<!-- <link rel="import" href="../bower_components/iron-icons/iron-icons.html"> -->
<link rel="import" href="my-icons.html">
<link rel="import" href="fire-app.html">
<!--<link rel="import" href="fire-store.html">
 -->

<script src="https://www.gstatic.com/firebasejs/3.2.1/firebase.js"></script>
<script>  // Initialize Firebase
  /*var config = {
    "apiKey":        "AIzaSyC32ZX3rKvRFJTGZ7vVxxQX-WJCDPC01Dk",
    "authDomain":    "wolke7-fd941.firebaseapp.com",
    "databaseURL":   "https://wolke7-fd941.firebaseio.com",
    "storageBucket": "wolke7-fd941.appspot.com"
  };
  firebase.initializeApp(config);*/
</script>

<dom-module id="fire-shield">

  <!-- Defines the element's style and local DOM -->
  <template>

    <style>
      :host {
        display: block;
        padding: 10px;
      }

      .flex-horizontal {
        @apply(--layout-horizontal);
      }   

      .flex-vertical {
        @apply(--layout-vertical);
      }   
      .flex {
        @apply(--layout-flex);
      }

      div.hidden {
        display: none;
      }
      /* Splash Page */
      #splashpage {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: #0288D1;
          background: radial-gradient(circle, #039BE5, #01579b);
          z-index: 10000;
          display: flex;
          justify-content: center;
          align-items: center;
          color: white;
          flex-direction: column;
      }     

    </style>

    <fire-app app="[[app]]" fb="{{fb}}"></fire-app>

    <section id="splashpage"> 

      <h5>Authorization required</h5>

      <div>
        <paper-button on-tap="loginEmail" raised>SignIn byMail</paper-button>
        <paper-button on-tap="loginGoogle" raised>GoogleAccount</paper-button>
        <!-- <paper-button on-tap="loginAnonym" > Sign in anonym</paper-button> -->
      </div>

      <div id="email-auth-form" class="hidden" style="margin-top: 25px;">

        <div class="container flex-horizontal">Login: 
          <paper-input value="{{email}}" id="email" label="Email"></paper-input>
          &nbsp;&nbsp;&nbsp;
          <paper-input type="password" value="{{password}}" id="password" label="Password"></paper-input>
        </div>

        <div  class="container flex-horizontal">(optional) Profile: 
          <paper-input  value="{{displayname}}" id="displayname" label="displayName"></paper-input>
          &nbsp;&nbsp;&nbsp;
          <paper-input  value="{{photourl}}" id="photourl" label="photoUrl"></paper-input>
        </div>

        <br/><br/>

        <paper-button on-tap="emailSignIn" raised id="quickstart-sign-in" name="signin">Sign In</paper-button> <!-- disabled -->
        <paper-button on-tap="emailSignUp" raised id="quickstart-sign-up" name="signup">Sign Up</paper-button>
        <paper-button on-tap="sendEmailVerification" raised disabled id="quickstart-verify-email" name="verify-email">Verify account</paper-button>
        <paper-button on-tap="sendPasswordReset" raised id="quickstart-password-reset" name="verify-email">Reset password</paper-button>
      
      </div>

    </section>       

  </template>

  <!-- Creates the element's prototype and registers it -->
  <script>

    Polymer({

      is: 'fire-shield',
      
      properties: {

        app: {  
          type: String
        },

        fb: {
          type: Object,
          observer: 'authObserver'
        },

        email: {
          type: String,
          value: ""
        },
        password: {
          type: String,
          value: ""
        },
        displayname: {
          type: String,
          value: ""
        },
        photourl: {
          type: String,
          value: ""
        }
      },

      observers: [
      ],

      ready: function() { console.log("fb-shield ready"); 
         this.uploadpath = this.path;
       },
        
      authObserver: function(fb, fbold) {  console.log("authObserver in fb=", fb);
        if (!fb || (typeof fb.auth !== "function")) return;  
        
        var that = this;
        var splashpage = this.$.splashpage;
        fb.auth().onAuthStateChanged(function(user) { console.log("actual user:",user); //,"splashpage", splashpage);
          if (user && !user.isAnonymous) {
              splashpage.style.display = 'none';
              // A. Log the editing user   
              // writeUserData(
              //     user.uid, 
              //     user.displayName, 
              //     user.email, 
              //     user.photoURL
              // );
              // B. 
              // startDatabaseQueries();
          } else {
            splashpage.style.display = '';
          }
        });
      },

      loginGoogle: function() { console.log("loginGoogle for", this.fb); 
        // library 'firebase.js' must be locally available in this element
        var provider = new firebase.auth.GoogleAuthProvider();     
        // var provider = new firebase.auth.GithubAuthProvider(); // Alternativ
        this.fb.auth().signInWithPopup(provider)
          .then(function(){         console.log("GoogleAccount SignIn OK.") 
          })
          .catch(function(error) {  console.error('GoogleAccount SignIn Error', error);
            this.user = null;
          });
      },

      loginAnonym: function() { console.log("loginAnonym for", this.fb); 
        // library 'firebase.js' must be locally available in this element
        // var provider = new firebase.auth.GoogleAuthProvider();     
        // var provider = new firebase.auth.GithubAuthProvider(); // Alternativ
        // this.fb.auth().signInWithPopup(provider);
      },

      loginEmail: function() {
        // toggle visibility of email-auth-form
        Polymer.dom(this.root).querySelector('#email-auth-form').classList.toggle('hidden');
      },

      /**
       * Handling the email-signIn(signUp)
       */
      emailSignIn: function(e, email, password) {
        if (this.fb.auth().currentUser) {
          // [START signout]
          this.fb.auth().signOut();
          // [END signout]
        } else {

          if (!email)     email    = this.email;
          if (!password)  password = this.password;

          if (email.length < 4) {
            alert('Please enter an email (ncount>3).');
            return;
          }
          if (password.length < 4) {
            alert('Please enter a password (ncount>3).');
            return;
          } // console.log("emailSignIn.LOG:", email, password); 
          
          // Sign in with email and pass.
          // [START authwithemail]
          // firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
          this.fb.auth().signInWithEmailAndPassword(email, password)
          .then(function() { 

            console.log("EmailLogin OK with",email, password);
          }) 
          .catch(function(error) {
            // Handle Errors here.
            var errorCode = error.code;
            var errorMessage = error.message;

            // [START_EXCLUDE]
            if (errorCode === 'auth/wrong-password') {
              alert('Wrong password.');
            } else {
              alert(errorMessage);
            }  console.log("ErrorLog:", error);
            
            // 
            Polymer.dom(this.root).querySelector('#sign-in').disabled = false;
            // [END_EXCLUDE]
          });
          // [END authwithemail]
        }
        // Polymer.dom(this.root).querySelector('#quickstart-sign-in').disabled = true;
      },

      emailSignUp: function() {
        var email     = this.email;
        var password  = this.password;
        if (email.length < 4) {
          alert('Please enter an email address.');
          return;
        }
        if (password.length < 4) {
          alert('Please enter a password.');
          return;
        }
        // Sign in with email and pass.
        // [START createwithemail]
        var that = this;
        // firebase.auth().createUserWithEmailAndPassword(email, password)
        this.fb.auth().createUserWithEmailAndPassword(email, password)
          .then(function(user) {  console.log("signed up new user:", user);
            that.setUserProfile(user);
          })
          .catch(function(error) {
            // Handle Errors here.
            var errorCode = error.code;
            var errorMessage = error.message;
            // [START_EXCLUDE]
            if (errorCode == 'auth/weak-password') {
              alert('The password is too weak.');
            } else if (errorCode == 'auth/email-already-in-use') {
              // if (confirm("The email address is used by existing account. SignIn");
              alert('The email address is used by existing account.');
              Polymer.dom(this.root).querySelector('#quickstart-sign-in').disabled = false;
              // emailSignIn(email, password);
            } else {
              alert(errorMessage);
            }
            console.log(error);
            // [END_EXCLUDE]
        });
        // [END createwithemail]
      },

      /**
       * [setUserProfile description]
       */
      setUserProfile: function(user, displayname, photourl){
        // some basic features may be managed from client!!
        if (!displayname) displayname  = this.displayname;
        if (!photourl) photourl        = this.photourl;
        if (!displayname && !photourl) return;

        user.updateProfile({
          displayName: displayname,
          photoURL: photourl
        }).then(function() {
          console.log("Profile-Update successful.");
        }, function(error) {
          console.log("Profile-Update failed.", error);    // An error happened.
        });
      },

      sendEmailVerification: function() {
        // [START sendemailverification]
        this.fb.auth().currentUser.sendEmailVerification().then(function() {
          // Email Verification sent!
          // [START_EXCLUDE]
          alert('Email Verification Sent!');
          // [END_EXCLUDE]
        });
        // [END sendemailverification]
      },

      sendPasswordReset: function() {
        var email = this.email;
        // [START sendpasswordemail]
        this.fb.auth().sendPasswordResetEmail(email).then(function() {
          // Password Reset Email Sent!
          // [START_EXCLUDE]
          alert('Password Reset Email Sent!');
          // [END_EXCLUDE]
        }).catch(function(error) {
          // Handle Errors here.
          var errorCode    = error.code;
          var errorMessage = error.message;
          // [START_EXCLUDE]
          if (errorCode == 'auth/invalid-email') {
            alert(errorMessage);
          } else if (errorCode == 'auth/user-not-found') {
            alert(errorMessage);
          }
          console.log(error);
          // [END_EXCLUDE]
        });
        // [END sendpasswordemail];
      }

    });

  </script>

</dom-module>