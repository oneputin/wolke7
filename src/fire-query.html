<link rel="import" href="../bower_components/polymer/polymer.html">
<script src="https://www.gstatic.com/firebasejs/3.2.0/firebase.js"></script>

<link rel="import" href="fire-app.html">

<dom-module id="fire-query">

  <template>

    <style>
      :host {
        display: block;
      }
    </style>
    
    <fire-app app="[[app]]" fb="{{fb}}" ></fire-app>

    <!-- <h5>query-log: firebase [[url]]/[[path]]</h5> -->

  </template>

  <script>

    Polymer({
      is: 'fire-query',
      properties: {

        app: {  
          type: String
        },

        fb: {
          type: Object
        },

        path:{
          type: String
        },

        key: {
          type: String,
          value: ""
        },  

        item: {         // query(order)Item
          type: String  //, value: '_path_' 
        },
        
        itemvalue:{     // queryValue (of orderItem)
          type: String  
        },

        operator: {      // queryOperator(relating queryItem and queryValue)
          type: String
        },

        // count: 10,    // number of returned objects(records)
        data: {
          type: Object,
          notify: true
        },

        setdata: {
          type: Object
        }
      },

      observers: [
        'applyPathQuery(fb, path)',
        'applyItemQuery(fb, path, item, itemvalue)',
        'applyPathSave(fb, setdata, path, key)'
      ],

      ready: function() { // console.log("firequery-ready");

      },

      applyPathQuery: function(fb, path) { 
        
        if (this.item=="_path_") {  // console.log("applyPathQuery, path=", path); 

          var that = this; // ALTMODISCH (use bind() instead?)
          fb.database().ref(path).once('value').then(function(snapshot) { 
            // console.log("snapped pathmode", snapshot.val());
            that.data = snapshot.val();
          })
        }
      },

      applyItemQuery: function(fb, path, item, value) { 
        // console.log("applyItemQuery: ", "path="+path,"var="+ item,"val="+ value); 

        var that = this; // ALTMODISCH (use bind() instead?)

        var ref  = fb.database().ref(path).orderByChild(item);

        if (value && (value != '_all_') ) {
          var op = this.operator;
          if (!op) {
            ref = ref.equalTo(value);
          } else { console.log("use of operator '"+op+"' not implemented!"); 

          } // console.log("applyItemQuery prepared: ", ref); 
        } 

        // OPTIONAL 
        var count = this.count; 
        if (count > 0) { 
          ref = ref.limitToFirst(count)
          console.log("apply count to ref: ",count, ref);
        } 

        // APPLY the query 
        ref.once('value')
            .then(function(snapshot) { // console.log("query snapshot", snapshot.val());
              that.data = snapshot.val();
            })
            .catch( function (errorObject) {
              console.log("The read failed: " + errorObject.code);  
            });
      },

      applyPathSave: function(fb, dbData, dbPath, dbKey) { 
        // save the doc-reference to database
        if (!dbData || (dbData===null) || !Object.keys(dbData).length) {
          console.log("missing data to submit")
          return; 
        } //console.log("triggered save at path:", dbPath, dbData);
        
        // 1. Get unique key at the target path
        if (!fb.database().ref().child(dbPath)) { // target-node must exist to enable key-generator
          fb.database().ref(dbPath).set([]);
        }  
        if (!dbKey) dbKey = fb.database().ref().child(dbPath).push().key;   // console.log("dbDataSubmit", dbKey, dbData); // return;

        // 2. 
        var that = this;

        fb.database().ref(dbPath+'/'+dbKey).set(dbData);  // console.log("save at:", dbPath+'/'+dbKey);
        
        fb.database().ref(dbPath+'/'+dbKey).once('value').then(function(snapshot) { 
            console.log("data saved with key "+dbKey, snapshot.val());
            that.lastpath = dbPath+'/'+dbKey;
        })
      }  

    });
  </script>
</dom-module>