<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- <script src="https://www.gstatic.com/firebasejs/3.2.0/firebase.js"></script> -->
<script src="https://www.gstatic.com/firebasejs/3.2.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.2.0/firebase-database.js"></script>

<link rel="import" href="fire-app.html">

<dom-module id="fire-query">

  <template>

    <style>
      :host {
        display: block;
      }
    </style>
    
    <fire-app app="[[app]]" fb="{{fb}}" ></fire-app>

    <!-- <h5>query-log: firebase [[url]]/[[path]]</h5> -->

  </template>

  <script>

    Polymer({
      is: 'fire-query',
      properties: {

        app: {  
          type: String
        },

        fb: {
          type: Object
        },

        path:{
          type: String
        },

        key: {
          type: String
        },  

        item: {         // query(order)Item
          type: String  //, value: '_path_' 
        },
        
        itemvalue:{     // queryValue (of orderItem)
          type: String  
        },

        trigger: 1,      // optionally used for requeries 

        operator: {      // queryOperator(relating queryItem and queryValue)
          type: String
        },

        data: {
          type: Object,
          notify: true
        },

        setdata: {
          type: Object
        }
      },

      observers: [
        'applyPathQuery(fb, path)',//, trigger)',
        'applyItemQuery(fb, path, item, itemvalue)', // trigger)',
        'applyPathSave(fb, setdata, path, key)'
      ],

      ready: function() { // console.log("firequery-ready");

      },

      applyPathQuery: function(fb, path, trigger) { 
        // if (!trigger) return;    // fi 0
        if (this.item=="_path_") {  // console.log("applyPathQuery, path=", path, fb); 

          var that = this; // ALTMODISCH (use bind() instead?)
          fb.database().ref(path).once('value').then(function(snapshot) { 
            // console.log("snapped pathmode", snapshot.val());
            that.data = snapshot.val();
          })
        }
      },

      applyItemQuery: function(fb, path, item, value) {  //console.log("applyItemQuery: ", "path="+path,"var="+ item,"val="+ value); 
        //, trigger) {
        // if (!trigger) return;       // fi 0


        var ref  = fb.database().ref(path).orderByChild(item);

        if (value && (value != '_all_') ) {
          var op = this.operator;
          if (!op) {
            ref = ref.equalTo(value);
          } else { console.log("use of operator '"+op+"' not implemented!"); 

          } // console.log("applyItemQuery prepared: ", ref); 
        } 

        // OPTIONAL 
        var count = this.count; 
        if (count > 0) { 
          ref = ref.limitToFirst(count)
          console.log("apply count to ref: ",count, ref);
        } 

        var that = this; // ALTMODISCH (use bind() instead?)

        // APPLY the query 
        ref.once('value')
            .then(function(snapshot) {  // console.log("snapshot-value", snapshot.val());
              that.data = snapshot.val();
            })
            .catch( function (errorObject) {
              console.log("The read failed: " + errorObject.code);  
            });
      },

      applyPathSave: function(fb, dbData, dbPath, dbKey) { 

        // save the doc-reference to database
        if (!dbData || (dbData===null) || !Object.keys(dbData).length) {
          console.log("missing data to submit")
          return; 
        } // console.log("triggered save at path:", dbPath, dbData);
        
        if (!fb.database().ref().child(dbPath)) { // target-node must exist to enable key-generator
          fb.database().ref(dbPath).set([]);
        }  

        // 1. Get unique key at the target path
        if (!dbKey) dbKey = fb.database().ref().child(dbPath).push().key;   // console.log("dbDataSubmit", dbKey, dbData); // return;

        // 2. 
        var that = this;

        fb.database().ref(dbPath+'/'+dbKey).set(dbData);  // console.log("save at:", dbPath+'/'+dbKey);
        
        fb.database().ref(dbPath+'/'+dbKey).once('value').then(function(snapshot) { 
            console.log("data saved with key "+dbKey, snapshot.val());
            that.lastpath = dbPath+'/'+dbKey;
        })

        // 3.  reset !! to avoid save with altered data !!
        
        this.key = undefined; 
      }  

    });
  </script>
</dom-module>